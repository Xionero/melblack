<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เหมืองทองคำมหาสนุก - Clicker Game</title>
    <style>
        /* CSS ทั้งหมดเหมือนเดิม ไม่มีการเปลี่ยนแปลง */
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap');
        body { font-family: 'Kanit', sans-serif; background-color: transparent; color: #4a2c0c; display: flex; justify-content: center; align-items: flex-start; padding-top: 40px; box-sizing: border-box; min-height: 100vh; margin: 0; user-select: none; }
        .game-container { width: 800px; max-width: 95%; background-color: #c8b68e; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); padding: 20px; display: flex; gap: 20px; }
        .left-panel, .right-panel { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .save-load-container { background-color: #e6d8b8; padding: 15px; border-radius: 10px; border: 2px solid #a8936a; display: flex; flex-direction: column; gap: 10px; }
        .save-load-container input { padding: 8px; border-radius: 5px; border: 1px solid #a8936a; font-family: 'Kanit', sans-serif; font-size: 1em; text-align: center; }
        .save-load-actions { display: flex; gap: 10px; }
        .save-load-actions button { flex: 1; padding: 8px; font-family: 'Kanit', sans-serif; font-size: 1em; border-radius: 5px; border: 2px solid #8c6f3e; cursor: pointer; transition: background-color 0.2s; }
        #save-button { background-color: #a8e6cf; }
        #save-button:hover { background-color: #81c7a8; }
        #load-button { background-color: #d8a7a7; }
        #load-button:hover { background-color: #c18c8c; }
        .stats-container { background-color: #e6d8b8; padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #a8936a; }
        .stats-container h1 { margin: 0; font-size: 2.5em; color: #d4af37; text-shadow: 1px 1px 2px #4a2c0c; }
        .stats-container p { margin: 5px 0 0; font-size: 1.2em; }
        .main-action { text-align: center; }
        #click-button { background: none; border: none; cursor: pointer; padding: 0; transition: transform 0.1s ease-out; }
        #click-button:active { transform: scale(0.95); }
        #click-button img { width: 200px; }
        .store-container h2 { text-align: center; margin-top: 0; border-bottom: 2px solid #a8936a; padding-bottom: 8px; margin-bottom: 10px; font-size: 1.3em; }
        .item, .click-upgrade-item { background-color: #e6d8b8; padding: 8px; border-radius: 8px; border: 2px solid #a8936a; display: flex; flex-direction: column; gap: 6px; }
        .click-upgrade-item { background-color: #fffacd; }
        .item-info { display: flex; justify-content: space-between; font-weight: bold; font-size: 0.95em; }
        .item-stats { font-size: 0.85em; color: #6c481c; }
        .item-actions { display: flex; gap: 10px; }
        .item-actions button { flex: 1; padding: 6px; font-family: 'Kanit', sans-serif; font-size: 0.9em; border-radius: 5px; border: 2px solid #8c6f3e; cursor: pointer; background-color: #f5e5b8; transition: background-color 0.2s; }
        .item-actions button:hover:not(:disabled) { background-color: #ffd700; }
        .item-actions button:disabled { background-color: #b0a38d; cursor: not-allowed; color: #7d6b50; border-color: #9c8b70; }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- HTML Layout เหมือนเดิม -->
        <div class="left-panel">
            <div class="stats-container"><h1 id="gold-display">0</h1><p>ทอง</p><p>อัตราการผลิต: <span id="gps-display">0</span> ทอง/วินาที</p><p>พลังคลิก: <span id="gpc-display">1</span></p></div>
            <div class="main-action"><button id="click-button"><img src="https://i.pinimg.com/originals/04/4d/12/044d12b83f0f1aa1012563a4701b0531.gif" alt="Gold Pile"></button></div>
            <div class="save-load-container"><input type="text" id="save-id-input" placeholder="ใส่ชื่อของคุณ"><div class="save-load-actions"><button id="save-button">บันทึกเกม</button><button id="load-button">โหลดเกม</button></div></div>
        </div>
        <div class="right-panel">
            <div class="store-container"><h2>ร้านค้า & อัปเกรด</h2><div id="click-upgrade-container"></div><hr style="border-color: #a8936a; border-style: solid; border-width: 1px 0 0 0;"><div id="item-list"></div></div>
        </div>
    </div>

    <script>
        // ใส่ URL ของ Google Apps Script ที่ Deploy ใหม่ของคุณที่นี่
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzKVv6wcQxIH0129U4jQF9zfaHOYu1UjpLIs64NaHjUaWB2bVY1qvwf3gUO6oBaU2Ex/exec'; 
        
        let gameData = getInitialGameData();
        
        // --- DOM Elements (เหมือนเดิม) ---
        const goldDisplay = document.getElementById('gold-display');
        const gpsDisplay = document.getElementById('gps-display');
        const gpcDisplay = document.getElementById('gpc-display');
        const clickButton = document.getElementById('click-button');
        const saveIdInput = document.getElementById('save-id-input');
        const saveButton = document.getElementById('save-button');
        const loadButton = document.getElementById('load-button');

        // --- NEW: ปรับปรุงฟังก์ชัน saveGame ให้ง่ายขึ้น ---
        async function saveGame() {
            const saveId = saveIdInput.value.trim();
            if (!saveId) {
                alert('กรุณาใส่ชื่อก่อนครับ!');
                return;
            }
            saveButton.innerText = 'กำลังบันทึก...';
            saveButton.disabled = true;
            try {
                const dataToSave = { ...gameData };
                delete dataToSave.gold; // ลบ gold ออกจาก object ที่จะแปลงเป็น JSON

                const payload = {
                    saveId: saveId,
                    gold: gameData.gold,
                    gameDataJson: JSON.stringify(dataToSave)
                };

                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                alert(`เกมของคุณถูกบันทึกด้วยชื่อ: ${saveId}`);
            } catch (error) {
                console.error('Error saving game:', error);
                alert('เกิดข้อผิดพลาดในการบันทึกเกม!');
            } finally {
                saveButton.innerText = 'บันทึกเกม';
                saveButton.disabled = false;
            }
        }

        // --- NEW: ปรับปรุงฟังก์ชัน loadGame ให้ง่ายขึ้น ---
        async function loadGame() {
            const saveId = saveIdInput.value.trim();
            if (!saveId) {
                alert('กรุณาใส่ชื่อที่ต้องการโหลด!');
                return;
            }
            loadButton.innerText = 'กำลังโหลด...';
            loadButton.disabled = true;
            try {
                const response = await fetch(`${SCRIPT_URL}?saveId=${saveId}`);
                const result = await response.json();
                
                if (result.status === "success") {
                    // result.data จะเป็น object ที่มี gold และ gameDataJson
                    const otherData = JSON.parse(result.data.gameDataJson);

                    // ประกอบร่าง gameData ขึ้นมาใหม่
                    const loadedGameData = {
                        gold: parseFloat(result.data.gold),
                        ...otherData
                    };
                    
                    // (Optional) ตรวจสอบความเข้ากันได้กับเซฟเก่า
                    if (!loadedGameData.clickUpgrade) {
                        loadedGameData.clickUpgrade = getInitialGameData().clickUpgrade;
                    }

                    gameData = loadedGameData;
                    alert(`โหลดข้อมูลสำหรับชื่อ "${saveId}" สำเร็จ!`);
                    
                    initializeStore();
                    updateDisplay();
                } else if (result.status === "not_found") {
                    alert(`ไม่พบข้อมูลเซฟสำหรับชื่อ "${saveId}"`);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error loading game:', error);
                alert('เกิดข้อผิดพลาดในการโหลดเกม!');
            } finally {
                loadButton.innerText = 'โหลดเกม';
                loadButton.disabled = false;
            }
        }
        
        // --- ฟังก์ชันอื่นๆ ทั้งหมดเหมือนเดิม ไม่มีการเปลี่ยนแปลง ---
        function getInitialGameData() { return { gold: 0, goldPerClick: 1, clickUpgrade: { name: 'ถุงมือทองคำ', level: 1, maxLevel: 10, baseCost: 50, currentCost: 50 }, items: { miner: { name: 'คนงานเหมือง', count: 0, level: 1, baseCost: 15, currentCost: 15, baseGps: 0.1, upgradeCost: 100 }, minecart: { name: 'รถเข็นขนแร่', count: 0, level: 1, baseCost: 100, currentCost: 100, baseGps: 1, upgradeCost: 1000 }, smelter: { name: 'โรงหลอม', count: 0, level: 1, baseCost: 1200, currentCost: 1200, baseGps: 8, upgradeCost: 15000 }, excavator: { name: 'รถขุดเจาะ', count: 0, level: 1, baseCost: 15000, currentCost: 15000, baseGps: 50, upgradeCost: 200000 } } }; }
        function mineGold() { gameData.gold += gameData.goldPerClick; updateDisplay(); }
        function buyClickUpgrade() { const upgrade = gameData.clickUpgrade; if (upgrade.level < upgrade.maxLevel && gameData.gold >= upgrade.currentCost) { gameData.gold -= upgrade.currentCost; upgrade.level++; gameData.goldPerClick = upgrade.level; upgrade.currentCost = Math.ceil(upgrade.baseCost * Math.pow(2.5, upgrade.level - 1)); updateDisplay(); } }
        function buyItem(itemId) { const item = gameData.items[itemId]; if (gameData.gold >= item.currentCost) { gameData.gold -= item.currentCost; item.count++; item.currentCost = Math.ceil(item.baseCost * Math.pow(1.15, item.count)); updateDisplay(); } }
        function upgradeItem(itemId) { const item = gameData.items[itemId]; if (gameData.gold >= item.upgradeCost) { gameData.gold -= item.upgradeCost; item.level++; item.upgradeCost = Math.ceil(item.upgradeCost * 3.5); updateDisplay(); } }
        function calculateTotalGps() { let totalGps = 0; if (!gameData.items) return 0; for (const itemId in gameData.items) { const item = gameData.items[itemId]; const itemGps = item.count * item.baseGps * Math.pow(2, item.level - 1); totalGps += itemGps; } return totalGps; }
        function updateDisplay() { const totalGps = calculateTotalGps(); goldDisplay.innerText = Math.floor(gameData.gold).toLocaleString(); gpsDisplay.innerText = totalGps.toFixed(1).toLocaleString(); gpcDisplay.innerText = gameData.goldPerClick.toLocaleString(); const upgrade = gameData.clickUpgrade; const upgradeBtn = document.getElementById('click-upgrade-btn'); const upgradeLevelText = document.getElementById('click-upgrade-level'); if(upgradeBtn && upgradeLevelText) { upgradeLevelText.innerText = `Lv. ${upgrade.level}`; if (upgrade.level >= upgrade.maxLevel) { upgradeBtn.innerText = 'สูงสุดแล้ว'; upgradeBtn.disabled = true; } else { upgradeBtn.innerText = `อัปเกรด (${upgrade.currentCost.toLocaleString()})`; upgradeBtn.disabled = gameData.gold < upgrade.currentCost; } } for (const itemId in gameData.items) { const item = gameData.items[itemId]; const itemDiv = document.getElementById(`item-${itemId}`); if (itemDiv) { const itemGps = item.count * item.baseGps * Math.pow(2, item.level - 1); itemDiv.querySelector('.item-level').innerText = `Lv. ${item.level}`; itemDiv.querySelector('.item-count').innerText = `จำนวน: ${item.count}`; itemDiv.querySelector('.item-gps').innerText = `GPS: ${itemGps.toFixed(1)}`; const buyBtn = itemDiv.querySelector('.buy-btn'); buyBtn.innerText = `ซื้อ (${item.currentCost.toLocaleString()})`; buyBtn.disabled = gameData.gold < item.currentCost; const upgradeBtn = itemDiv.querySelector('.upgrade-btn'); upgradeBtn.innerText = `อัปเกรด (${item.upgradeCost.toLocaleString()})`; upgradeBtn.disabled = gameData.gold < item.upgradeCost; } } }
        function initializeStore() { const clickUpgradeContainer = document.getElementById('click-upgrade-container'); clickUpgradeContainer.innerHTML = ''; const upgrade = gameData.clickUpgrade; const upgradeDiv = document.createElement('div'); upgradeDiv.className = 'click-upgrade-item'; upgradeDiv.innerHTML = `<div class="item-info"><span>${upgrade.name} <span id="click-upgrade-level">Lv. ${upgrade.level}</span></span></div><div class="item-stats"><span>เพิ่มพลังการคลิก +1 ต่อเลเวล</span></div><div class="item-actions"><button id="click-upgrade-btn" onclick="buyClickUpgrade()"></button></div>`; clickUpgradeContainer.appendChild(upgradeDiv); const itemListDiv = document.getElementById('item-list'); itemListDiv.innerHTML = ''; for (const itemId in gameData.items) { const item = gameData.items[itemId]; const itemDiv = document.createElement('div'); itemDiv.className = 'item'; itemDiv.id = `item-${itemId}`; itemDiv.innerHTML = `<div class="item-info"><span>${item.name} <span class="item-level">Lv. ${item.level}</span></span><span class="item-count">จำนวน: ${item.count}</span></div><div class="item-stats"><span class="item-gps">GPS: 0.0</span></div><div class="item-actions"><button class="buy-btn" onclick="buyItem('${itemId}')">ซื้อ</button><button class="upgrade-btn" onclick="upgradeItem('${itemId}')">อัปเกรด</button></div>`; itemListDiv.appendChild(itemDiv); } }
        function gameLoop() { const totalGps = calculateTotalGps(); gameData.gold += totalGps; updateDisplay(); }
        clickButton.addEventListener('click', mineGold); saveButton.addEventListener('click', saveGame); loadButton.addEventListener('click', loadGame);
        initializeStore(); setInterval(gameLoop, 1000); updateDisplay();
    </script>
</body>
</html>
